<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Money note</title>

  <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone / Add to Home Screen -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <!-- ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏ä‡πâ favicon ‡∏ö‡∏ô browser ‡∏õ‡∏Å‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢
  <link rel="icon" type="image/png" sizes="32x32" href="apple-touch-icon.png">
  -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Money note">

  <style>
    :root {
      --radius-card: 16px;
      --shadow-card: 0 10px 25px rgba(15, 23, 42, 0.12);
      --accent: #0ea5e9;
      --income-color: #22c55e;
      --expense-color: #fb7185;
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      margin: 0;
      padding: 12px;
      background: radial-gradient(circle at top, #e0f2fe, #fdf2ff 45%, #f9fafb 80%);
      color: #111827;
      -webkit-font-smoothing: antialiased;
    }

    .page-frame {
      max-width: 520px;
      margin: 0 auto;
      background: rgba(255,255,255,0.94);
      border-radius: 26px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 20px 40px rgba(15,23,42,0.18);
      min-height: 96vh;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(18px);
    }

    .page-inner {
      padding: 16px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex: 1;
      padding-bottom: 64px;
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin: 0 0 4px;
      font-weight: 700;
      background: linear-gradient(120deg, #0ea5e9, #6366f1, #ec4899);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .month-balance {
      margin: 8px auto 0;
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg,#ecfeff,#f5f3ff);
      border: 1px solid #bae6fd;
      font-size: 12px;
      color: #0369a1;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .month-balance strong { font-weight: 700; }

    h2 {
      font-size: 15px;
      margin: 0 0 10px;
      font-weight: 600;
      color: #0f172a;
    }

    .panel {
      border-radius: var(--radius-card);
      padding: 14px 14px 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: linear-gradient(135deg, rgba(224,242,254,0.9), rgba(248,250,252,0.97));
    }

    .panel-form { box-shadow: var(--shadow-card); }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      color: #374151;
    }

    .field { margin-bottom: 8px; }

    input,
    button {
      font-family: inherit;
      font-size: 14px;
    }

    input[type="date"],
    input[type="month"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      outline: none;
      background: #f9fafb;
      transition: all 0.15s ease;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(14,165,233,0.25);
      background: #ffffff;
    }

    /* ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
    .type-toggle-wrapper {
      display: flex;
      justify-content: center;
      margin-top: 2px;
    }

    .type-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 3px;
      background: linear-gradient(120deg, #eef2ff, #e0f2fe);
      box-shadow: 0 6px 15px rgba(129,140,248,0.25);
    }

    .type-btn {
      min-width: 90px;
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      background: transparent;
      color: #4b5563;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.15s ease;
    }

    .type-btn.active-income {
      background: #dcfce7;
      color: #15803d;
      font-weight: 700;
      box-shadow: 0 3px 8px rgba(34,197,94,0.45);
    }

    .type-btn.active-expense {
      background: #ffe4e6;
      color: #be123c;
      font-weight: 700;
      box-shadow: 0 3px 8px rgba(248,113,113,0.45);
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn-primary {
      flex: 1 1 140px;
      text-align: center;
      border-radius: 999px;
      padding: 11px 14px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(59,130,246,0.45);
    }
    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 3px 8px rgba(59,130,246,0.5);
    }

    .btn-danger-ghost {
      border-radius: 999px;
      border: 1px solid #fecaca;
      background: #fff1f2;
      color: #b91c1c;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .cat-card {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 6px 4px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 11px;
      color: #374151;
      box-shadow: 0 2px 4px rgba(148,163,184,0.25);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border 0.1s ease;
    }

    .cat-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(148,163,184,0.4);
    }

    .cat-icon { font-size: 20px; }
    .cat-label { text-align: center; line-height: 1.2; }

    .cat-card.active {
      border-color: #fb923c;
      background: #fff7ed;
      box-shadow: 0 4px 10px rgba(251,146,60,0.55);
      color: #b45309;
      font-weight: 600;
    }

    /* SUMMARY TAB */
    .panel-summary {
      background: linear-gradient(135deg, #fdf2ff, #e0f2fe);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      font-size: 12px;
      color: #4b5563;
    }

    .filter-row span.label { font-weight: 500; }

    .filter-row input[type="month"],
    .filter-row input.year-input {
      width: auto;
      min-width: 130px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .balance-box {
      text-align: center;
      padding: 10px 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      margin-bottom: 10px;
    }

    .balance-label {
      font-size: 12px;
      color: #6b7280;
    }

    .balance-value {
      margin-top: 4px;
      font-size: 24px;
      font-weight: 800;
      color: #0f172a;
    }

    /* ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ */
    .bar-chart-month {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: flex-end;
      min-height: 140px;
      padding: 6px 4px 4px;
    }
    .bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    .bar-rect {
      width: 32px;
      border-radius: 10px 10px 4px 4px;
      background: #e5e7eb;
      transition: height 0.2s ease;
      height: 10px;
    }
    .bar-rect.income {
      background: linear-gradient(180deg,#bbf7d0,#22c55e);
    }
    .bar-rect.expense {
      background: linear-gradient(180deg,#fecaca,#fb7185);
    }
    .bar-label { color:#4b5563; font-weight:600; }
    .bar-value { font-size:12px; color:#111827; }

    .pie-legend {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      min-width: 140px;
      margin-top: 4px;
    }

    .legend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.95);
      padding: 5px 8px;
      border-radius: 10px;
      border: 1px solid rgba(226,232,240,0.9);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .legend-item.active {
      border-color:#fb7185;
      background:#fff7ed;
    }

    .legend-left { display: flex; align-items: center; gap: 6px; }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-label { font-weight: 600; }
    .legend-amount { font-weight: 600; }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ */
    .category-detail {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(226,232,240,0.9);
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .category-detail-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }
    .category-detail-hint {
      font-size:11px;
      color:#6b7280;
    }
    .category-detail-list {
      list-style:none;
      padding:0;
      margin:4px 0 0;
    }
    .category-detail-list li {
      display:flex;
      justify-content:space-between;
      gap:6px;
      padding:2px 0;
      border-bottom:1px dashed #e5e7eb;
    }
    .category-detail-list li:last-child {
      border-bottom:none;
    }
    .category-detail-left {
      display:flex;
      flex-direction:column;
    }
    .category-detail-date {
      font-size:11px;
      color:#6b7280;
    }
    .category-detail-name {
      font-size:12px;
      color:#111827;
    }
    .category-detail-amount {
      font-weight:600;
    }

    /* Pie chart ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏£‡∏±‡∏ö vs ‡∏à‡πà‡∏≤‡∏¢) */
    .pie-chart-year {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      background: conic-gradient(#e5e7eb 0 100%);
      position: relative;
      box-shadow: 0 8px 18px rgba(148,163,184,0.5);
      border: 6px solid rgba(255,255,255,0.9);
    }

    .pie-center-label {
      position: absolute;
      inset: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #6b7280;
      box-shadow: 0 0 0 1px rgba(226,232,240,0.9);
    }

    .pie-center-value {
      font-weight: 700;
      font-size: 13px;
      color: #0f172a;
      margin-top: 2px;
    }

    /* ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏ö‡πà‡∏á‡∏ß‡∏±‡∏ô / ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    .report-container {
      /* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ scroll ‡∏ã‡πâ‡∏≠‡∏ô */
      max-height: none;
      overflow-y: visible;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: 4px;
    }

    .day-card {
      border-radius: 20px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      box-shadow: 0 4px 12px rgba(148,163,184,0.4);
      overflow: hidden;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: linear-gradient(135deg,#eef2ff,#e0f2fe);
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
    }

    .day-title {
      font-size: 13px;
      font-weight: 700;
      color: #1f2937;
    }

    .day-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #4b5563;
    }

    .day-total {
      font-size: 12px;
      color: #4b5563;
    }

    .day-toggle {
      font-size: 14px;
      color: #6b7280;
    }

    .day-body {
      padding: 0 6px 8px 6px;
      display: block;
    }

    .day-card.collapsed .day-body { display: none; }

    .day-table-outer {
      margin-top: 6px;
      border-radius: 14px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(148,163,184,0.35);
      overflow: hidden;
    }

    /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ scroll ‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô card ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ scroll ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡∏ô */
    .day-table-scroll {
      max-height: none;
      overflow-y: visible;
    }

    .day-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #ffffff;
      table-layout: fixed;
    }

    .day-table th,
    .day-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      word-break: break-word;
    }

    .day-table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .day-table tr:last-child td { border-bottom: none; }

    .row-income td { background: #f0fdf4; }
    .row-expense td { background: #fef2f2; }

    .text-right { text-align: right; }

    .tag-income { color: var(--income-color); font-weight: 600; }
    .tag-expense { color: var(--expense-color); font-weight: 600; }

    .row-actions {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
    }

    .row-btn {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .row-btn.edit { color: #0ea5e9; }
    .row-btn.delete { color: #b91c1c; }

    .no-data {
      text-align: center;
      color: #9ca3af;
      padding: 10px 0;
      font-size: 12px;
    }

    /* Tabs ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
    .tab-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px 10px;
      border-top: 1px solid rgba(148,163,184,0.35);
      background: rgba(248,250,252,0.96);
      display: flex;
      gap: 8px;
      justify-content: space-between;
      backdrop-filter: blur(12px);
    }

    .tab-btn {
      flex: 1 1 0;
      border-radius: 999px;
      border: 1px solid #cbd5e1;
      background: #e5e7eb;
      padding: 8px 10px;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      color: #475569;
      font-weight: 500;
    }

    .tab-btn span.icon { font-size: 15px; }

    .tab-btn.active {
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 6px 14px rgba(59,130,246,0.45);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    @media (max-width: 430px) {
      body { padding: 8px; }
      .page-inner { padding: 12px 10px 8px; }
      h1 { font-size: 20px; }
      .pie-chart-year { width: 120px; height: 120px; }
    }
  </style>
</head>
<body>
  <div class="page-frame">
    <div class="page-inner">
      <!-- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô -->
      <div id="tab1" class="tab-content active">
        <div class="panel panel-form">
          <h1>Money note</h1>
          <div class="subtitle">‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</div>

          <div class="field">
            <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="date">
          </div>

          <div class="field">
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <div class="type-toggle-wrapper">
              <div class="type-toggle" id="typeToggle">
                <button type="button" class="type-btn active-income" id="btnIncome" data-type="income">
                  ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                </button>
                <button type="button" class="type-btn" id="btnExpense" data-type="expense">
                  ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                </button>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
            <input type="text" id="title" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏Å‡∏≤‡πÅ‡∏ü, ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î">
          </div>

          <div class="field">
            <label for="amount">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" id="amount" min="0" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3500">
          </div>

          <div class="field">
            <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <div id="categoryGrid" class="category-grid"></div>
          </div>

          <div class="button-row">
            <button class="btn-primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>

          <div class="month-balance">
            ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:
            <strong id="monthBalanceValue">0.00 ‡∏ø</strong>
          </div>
        </div>
      </div>

      <!-- TAB 2: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
      <div id="tab2" class="tab-content">
        <div class="panel panel-summary">
          <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>

          <div class="filter-row">
            <span class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ:</span>
            <input type="month" id="filterMonth">
            <button class="btn-danger-ghost" id="btnClearAll">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>

          <div class="balance-box">
            <div class="balance-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <div class="balance-value" id="balanceMonth">0.00 ‡∏ø</div>
          </div>

          <div class="bar-chart-month">
            <div class="bar-col">
              <div id="barIncome" class="bar-rect income"></div>
              <div class="bar-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
              <div id="barIncomeValue" class="bar-value">0.00 ‡∏ø</div>
            </div>
            <div class="bar-col">
              <div id="barExpense" class="bar-rect expense"></div>
              <div class="bar-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
              <div id="barExpenseValue" class="bar-value">0.00 ‡∏ø</div>
            </div>
          </div>

          <div class="pie-legend" id="categoryLegendMonth"></div>

          <div id="categoryDetailMonth" class="category-detail">
            <div class="category-detail-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
            <div class="category-detail-hint">
              ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            </div>
          </div>
        </div>

        <div class="table-panel">
          <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h2>
          <div id="reportContainerMonth" class="report-container"></div>
        </div>
      </div>

      <!-- TAB 3: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ -->
      <div id="tab3" class="tab-content">
        <div class="panel panel-summary">
          <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h2>

          <div class="filter-row">
            <span class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ (‡∏Ñ.‡∏®.):</span>
            <input type="number" id="filterYear" class="year-input" min="2000" max="2099" step="1">
          </div>

          <div class="balance-box">
            <div class="balance-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <div class="balance-value" id="balanceYear">0.00 ‡∏ø</div>
          </div>

          <div class="pie-wrapper">
            <div class="pie-chart-year" id="pieChartYear">
              <div class="pie-center-label">
                <div>‡∏£‡∏±‡∏ö / ‡∏à‡πà‡∏≤‡∏¢</div>
                <div class="pie-center-value" id="pieCenterLabelYear">0 : 0</div>
              </div>
            </div>
            <div class="pie-legend">
              <div class="legend-item" style="cursor:default">
                <div class="legend-left">
                  <span class="legend-dot" style="background:var(--income-color)"></span>
                  <span class="legend-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                </div>
                <span class="legend-amount" id="legendIncomeYear">0.00 ‡∏ø</span>
              </div>
              <div class="legend-item" style="cursor:default">
                <div class="legend-left">
                  <span class="legend-dot" style="background:var(--expense-color)"></span>
                  <span class="legend-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                </div>
                <span class="legend-amount" id="legendExpenseYear">0.00 ‡∏ø</span>
              </div>
            </div>
          </div>
        </div>

        <div class="table-panel">
          <h2>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
          <div id="reportContainerYear" class="report-container"></div>
        </div>
      </div>
    </div>

    <!-- ‡πÅ‡∏ó‡πá‡∏ö‡∏•‡πà‡∏≤‡∏á -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="tab1">
        <span class="icon">üìù</span>
        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      </button>
      <button class="tab-btn" data-tab="tab2">
        <span class="icon">üìÖ</span>
        ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
      </button>
      <button class="tab-btn" data-tab="tab3">
        <span class="icon">üìÜ</span>
        ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
      </button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'money_note_transactions_v5';

    let currentType = 'income';
    let selectedCategoryKey = null;
    let editingId = null;

    const incomeCategories = [
      { key: 'salary',     label: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',          icon: 'üíº' },
      { key: 'bonus',      label: '‡πÇ‡∏ö‡∏ô‡∏±‡∏™',              icon: 'üéÅ' },
      { key: 'dividend',   label: '‡∏õ‡∏±‡∏ô‡∏ú‡∏•‡∏´‡∏∏‡πâ‡∏ô',          icon: 'üí∏' },
      { key: 'stockGain',  label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏´‡∏∏‡πâ‡∏ô / ‡πÄ‡∏ó‡∏£‡∏î',   icon: 'üìà' },
      { key: 'interest',   label: '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å',    icon: 'üí∞' },
      { key: 'side',       label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°',        icon: 'üåü' },
      { key: 'ot',         label: '‡πÇ‡∏≠‡∏ó‡∏µ',               icon: '‚è±Ô∏è' },
      { key: 'rentIncome', label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô',   icon: 'üè¢' },
      { key: 'taxRefund',  label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏†‡∏≤‡∏©‡∏µ',        icon: 'üßæ' },
      { key: 'otherIncome',label: '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',             icon: '‚ú®' }
    ];

    const expenseCategories = [
      { key: 'food',         label: '‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£',           icon: 'üçö' },
      { key: 'house',        label: '‡∏Ñ‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô',            icon: 'üè†' },
      { key: 'car',          label: '‡∏Ñ‡πà‡∏≤‡∏£‡∏ñ',              icon: 'üöó' },
      { key: 'transport',    label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',         icon: 'üöÜ' },
      { key: 'shopping',     label: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',           icon: 'üõçÔ∏è' },
      { key: 'entertain',    label: '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á',            icon: 'üé¨' },
      { key: 'health',       label: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',             icon: 'üè•' },
      { key: 'bill',         label: '‡∏ö‡∏¥‡∏•/‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ', icon: 'üí°' },
      { key: 'insurance',    label: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',             icon: 'üõ°Ô∏è' },
      { key: 'education',    label: '‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤',           icon: 'üìö' },
      { key: 'travel',       label: '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß',         icon: '‚úàÔ∏è' },
      { key: 'family',       label: '‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß',           icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
      { key: 'otherExpense', label: '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',             icon: '‚ú®' }
    ];

    function getCategoryList(type) {
      return type === 'income' ? incomeCategories : expenseCategories;
    }

    function findCategory(type, key) {
      return getCategoryList(type).find(c => c.key === key);
    }

    /* --- Storage helpers --- */
    function loadTransactions() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveTransactions(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function formatNumber(num) {
      return num.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function todayString() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function setTodayAndMax() {
      const dateInput = document.getElementById('date');
      const today = todayString();
      dateInput.value = today;
      dateInput.max = today;

      const filterMonth = document.getElementById('filterMonth');
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const ym = `${yyyy}-${mm}`;
      filterMonth.value = ym;
      filterMonth.max = ym;

      const filterYear = document.getElementById('filterYear');
      if (filterYear) {
        filterYear.value = String(yyyy);
        filterYear.max = String(yyyy);
      }
    }

    /* --- UI helpers --- */

    function formatDisplayDateBE(dateStr) {
      if (!dateStr) return '';
      const [y, m, d] = dateStr.split('-').map(n => parseInt(n, 10));
      const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                      '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
      const yearBE = y + 543;
      return `${d} ${months[m - 1]} ${yearBE}`;
    }

    function populateCategoryGrid() {
      const container = document.getElementById('categoryGrid');
      container.innerHTML = '';
      const categories = getCategoryList(currentType);

      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cat-card' + (cat.key === selectedCategoryKey ? ' active' : '');
        btn.addEventListener('click', () => {
          selectedCategoryKey = cat.key;
          populateCategoryGrid();
        });

        const icon = document.createElement('div');
        icon.className = 'cat-icon';
        icon.textContent = cat.icon;

        const label = document.createElement('div');
        label.className = 'cat-label';
        label.textContent = cat.label;

        btn.appendChild(icon);
        btn.appendChild(label);
        container.appendChild(btn);
      });
    }

    function setType(type) {
      currentType = type;
      selectedCategoryKey = null;

      const btnIncome = document.getElementById('btnIncome');
      const btnExpense = document.getElementById('btnExpense');

      if (type === 'income') {
        btnIncome.classList.add('active-income');
        btnExpense.classList.remove('active-expense');
      } else {
        btnExpense.classList.add('active-expense');
        btnIncome.classList.remove('active-income');
      }
      populateCategoryGrid();
    }

    /* Pie chart (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ) = ‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ */
    function updatePieChart(totalIncome, totalExpense, pieChart, centerEl, legendIncome, legendExpense) {
      const total = totalIncome + totalExpense;

      legendIncome.textContent = formatNumber(totalIncome) + ' ‡∏ø';
      legendExpense.textContent = formatNumber(totalExpense) + ' ‡∏ø';

      if (total <= 0) {
        pieChart.style.background = 'conic-gradient(#e5e7eb 0 100%)';
        centerEl.textContent = '0 : 0';
        return;
      }

      const incomePercent = (totalIncome / total) * 100;
      const expensePercent = 100 - incomePercent;

      pieChart.style.background =
        `conic-gradient(var(--income-color) 0 ${incomePercent}%, var(--expense-color) ${incomePercent}% 100%)`;

      const iShort = Math.round(incomePercent);
      const eShort = 100 - iShort;
      centerEl.textContent = `${iShort}% : ${eShort}%`;
    }

    /* ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô */
    function resetBarChartMonth() {
      const barIncome = document.getElementById('barIncome');
      const barExpense = document.getElementById('barExpense');
      const incomeVal = document.getElementById('barIncomeValue');
      const expenseVal = document.getElementById('barExpenseValue');

      barIncome.style.height = '10px';
      barExpense.style.height = '10px';
      incomeVal.textContent = '0.00 ‡∏ø';
      expenseVal.textContent = '0.00 ‡∏ø';
    }

    function updateBarChartMonth(totalIncome, totalExpense) {
      const barIncome = document.getElementById('barIncome');
      const barExpense = document.getElementById('barExpense');
      const incomeVal = document.getElementById('barIncomeValue');
      const expenseVal = document.getElementById('barExpenseValue');

      const max = Math.max(totalIncome, totalExpense, 1);
      const minHeight = 10;  // px
      const maxHeight = 120; // px

      const incomeH = minHeight + (totalIncome / max) * (maxHeight - minHeight);
      const expenseH = minHeight + (totalExpense / max) * (maxHeight - minHeight);

      barIncome.style.height = incomeH + 'px';
      barExpense.style.height = expenseH + 'px';

      incomeVal.textContent = formatNumber(totalIncome) + ' ‡∏ø';
      expenseVal.textContent = formatNumber(totalExpense) + ' ‡∏ø';
    }

    function resetCategoryDetailMonth() {
      const box = document.getElementById('categoryDetailMonth');
      if (!box) return;
      box.innerHTML = `
        <div class="category-detail-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
        <div class="category-detail-hint">
          ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        </div>
      `;
    }

    function showCategoryDetailsMonth(catKey, label, listMonth) {
      const box = document.getElementById('categoryDetailMonth');
      if (!box) return;

      const items = listMonth.filter(
        item => item.type === 'expense' && item.categoryKey === catKey
      );

      if (items.length === 0) {
        box.innerHTML = `
          <div class="category-detail-title">${label}</div>
          <div class="category-detail-hint">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        `;
        return;
      }

      const htmlParts = [];
      htmlParts.push(`<div class="category-detail-title">${label}</div>`);
      htmlParts.push('<ul class="category-detail-list">');

      items
        .sort((a,b) => a.date.localeCompare(b.date))
        .forEach(item => {
          const dateLabel = formatDisplayDateBE(item.date);
          const title = item.title || '';
          const amt = formatNumber(item.amount);
          htmlParts.push(`
            <li>
              <div class="category-detail-left">
                <span class="category-detail-name">${title}</span>
                <span class="category-detail-date">${dateLabel}</span>
              </div>
              <span class="category-detail-amount">${amt} ‡∏ø</span>
            </li>
          `);
        });

      htmlParts.push('</ul>');
      box.innerHTML = htmlParts.join('');
    }

    /* ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (legend) */
    function updateExpenseCategoryListMonth(listMonth) {
      const legendContainer = document.getElementById('categoryLegendMonth');
      legendContainer.innerHTML = '';
      resetCategoryDetailMonth();

      const expenses = listMonth.filter(item => item.type === 'expense');
      if (expenses.length === 0) {
        const div = document.createElement('div');
        div.className = 'no-data';
        div.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
        legendContainer.appendChild(div);
        return;
      }

      const totals = {};
      expenses.forEach(item => {
        if (!totals[item.categoryKey]) totals[item.categoryKey] = 0;
        totals[item.categoryKey] += item.amount;
      });

      const entries = Object.keys(totals).map(key => {
        const cat = findCategory('expense', key) || { label: key, icon: '' };
        return { key, label: cat.label, icon: cat.icon, amount: totals[key] };
      });

      entries.sort((a, b) => b.amount - a.amount);

      const totalExpense = entries.reduce((sum, e) => sum + e.amount, 0);
      const colors = [
        '#fb7185','#f97316','#facc15','#22c55e','#0ea5e9','#6366f1',
        '#8b5cf6','#ec4899','#14b8a6','#a855f7','#f59e0b','#4b5563'
      ];

      entries.forEach((entry, idx) => {
        const percent = (entry.amount / totalExpense) * 100;
        const color = colors[idx % colors.length];

        const item = document.createElement('div');
        item.className = 'legend-item';

        const left = document.createElement('div');
        left.className = 'legend-left';

        const dot = document.createElement('span');
        dot.className = 'legend-dot';
        dot.style.background = color;

        const label = document.createElement('span');
        label.className = 'legend-label';
        label.textContent = entry.label + (entry.icon ? ` ${entry.icon}` : '');

        left.appendChild(dot);
        left.appendChild(label);

        const right = document.createElement('div');
        right.className = 'legend-amount';
        right.textContent = `${formatNumber(entry.amount)} ‡∏ø (${percent.toFixed(1)}%)`;

        item.appendChild(left);
        item.appendChild(right);

        // click ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô
        item.addEventListener('click', () => {
          legendContainer.querySelectorAll('.legend-item').forEach(li => li.classList.remove('active'));
          item.classList.add('active');
          showCategoryDetailsMonth(entry.key, entry.label, listMonth);
        });

        legendContainer.appendChild(item);
      });
    }

    function getFilteredByMonth(allList) {
      const filterMonthVal = document.getElementById('filterMonth').value;
      if (!filterMonthVal) return allList;

      const [yFilter, mFilter] = filterMonthVal.split('-').map(x => parseInt(x, 10));

      return allList.filter(item => {
        if (!item.date) return false;
        const [y, m] = item.date.split('-').map(x => parseInt(x, 10));
        return y === yFilter && m === mFilter;
      });
    }

    function getFilteredByYear(allList) {
      const filterYearVal = document.getElementById('filterYear').value;
      const yFilter = parseInt(filterYearVal, 10);
      if (!filterYearVal || isNaN(yFilter)) return allList;

      return allList.filter(item => {
        if (!item.date) return false;
        const [y] = item.date.split('-').map(x => parseInt(x, 10));
        return y === yFilter;
      });
    }

    function updateMonthBalance(allList) {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + 1;

      let balanceMonth = 0;

      allList.forEach(item => {
        const [yy, mm] = item.date.split('-').map(v => parseInt(v, 10));
        if (yy === y && mm === m) {
          balanceMonth += item.type === 'income' ? item.amount : -item.amount;
        }
      });

      document.getElementById('monthBalanceValue').textContent =
        formatNumber(balanceMonth) + ' ‡∏ø';
    }

    /* --- ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô) --- */
    function renderMonth(list) {
      const container = document.getElementById('reportContainerMonth');
      const balanceEl = document.getElementById('balanceMonth');

      container.innerHTML = '';

      if (list.length === 0) {
        const div = document.createElement('div');
        div.className = 'no-data';
        div.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ';
        container.appendChild(div);

        balanceEl.textContent = '0.00 ‡∏ø';
        resetBarChartMonth();
        updateExpenseCategoryListMonth([]);
        return;
      }

      let totalIncome = 0;
      let totalExpense = 0;

      list.forEach(item => {
        if (item.type === 'income') totalIncome += item.amount;
        else totalExpense += item.amount;
      });

      updateBarChartMonth(totalIncome, totalExpense);
      updateExpenseCategoryListMonth(list);

      const groups = {};
      list.forEach(item => {
        if (!groups[item.date]) groups[item.date] = [];
        groups[item.date].push(item);
      });

      const dates = Object.keys(groups).sort((a, b) => b.localeCompare(a));

      dates.forEach(dateStr => {
        const dayItems = groups[dateStr];

        const card = document.createElement('div');
        card.className = 'day-card';

        const header = document.createElement('div');
        header.className = 'day-header';

        const title = document.createElement('div');
        title.className = 'day-title';
        title.textContent = formatDisplayDateBE(dateStr);

        const right = document.createElement('div');
        right.className = 'day-right';

        const totalText = document.createElement('div');
        totalText.className = 'day-total';
        const dayNet = dayItems.reduce((sum, it) =>
          sum + (it.type === 'income' ? it.amount : -it.amount), 0);
        totalText.textContent = '‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ' + formatNumber(dayNet) + ' ‡∏ø';

        const toggleIcon = document.createElement('span');
        toggleIcon.className = 'day-toggle';
        toggleIcon.textContent = '‚ñæ';

        right.appendChild(totalText);
        right.appendChild(toggleIcon);

        header.appendChild(title);
        header.appendChild(right);
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = 'day-body';

        const tableOuter = document.createElement('div');
        tableOuter.className = 'day-table-outer';

        const tableScroll = document.createElement('div');
        tableScroll.className = 'day-table-scroll';

        const table = document.createElement('table');
        table.className = 'day-table';
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th>‡∏´‡∏°‡∏ß‡∏î</th>
            <th class="text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th class="text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        dayItems.forEach(item => {
          const tr = document.createElement('tr');
          tr.classList.add(item.type === 'income' ? 'row-income' : 'row-expense');

          const tdType = document.createElement('td');
          tdType.innerHTML = item.type === 'income'
            ? '<span class="tag-income">‡∏£‡∏±‡∏ö</span>'
            : '<span class="tag-expense">‡∏à‡πà‡∏≤‡∏¢</span>';
          tr.appendChild(tdType);

          const tdTitle = document.createElement('td');
          tdTitle.textContent = item.title || '';
          tr.appendChild(tdTitle);

          const catObj = findCategory(item.type, item.categoryKey);
          const catText = catObj ? `${catObj.label} ${catObj.icon}` : '';
          const tdCategory = document.createElement('td');
          tdCategory.textContent = catText;
          tr.appendChild(tdCategory);

          const tdAmount = document.createElement('td');
          tdAmount.className = 'text-right';
          tdAmount.textContent = formatNumber(item.amount);
          tr.appendChild(tdAmount);

          const tdActions = document.createElement('td');
          tdActions.className = 'text-right';
          const actionDiv = document.createElement('div');
          actionDiv.className = 'row-actions';

          const btnEdit = document.createElement('button');
          btnEdit.className = 'row-btn edit';
          btnEdit.textContent = '‚úèÔ∏è';
          btnEdit.addEventListener('click', (e) => {
            e.stopPropagation();
            startEdit(item.id);
          });

          const btnDelete = document.createElement('button');
          btnDelete.className = 'row-btn delete';
          btnDelete.textContent = 'üóëÔ∏è';
          btnDelete.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteTransaction(item.id);
          });

          actionDiv.appendChild(btnEdit);
          actionDiv.appendChild(btnDelete);
          tdActions.appendChild(actionDiv);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableScroll.appendChild(table);
        tableOuter.appendChild(tableScroll);
        body.appendChild(tableOuter);
        card.appendChild(body);

        header.addEventListener('click', () => {
          const collapsed = card.classList.toggle('collapsed');
          toggleIcon.textContent = collapsed ? '‚ñ∏' : '‚ñæ';
        });

        container.appendChild(card);
      });

      balanceEl.textContent = formatNumber(totalIncome - totalExpense) + ' ‡∏ø';
    }

    /* --- ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) --- */
    function renderYearSummary(listYear) {
      const container = document.getElementById('reportContainerYear');
      const balanceEl = document.getElementById('balanceYear');
      const pieChart = document.getElementById('pieChartYear');
      const pieCenter = document.getElementById('pieCenterLabelYear');
      const legendIncome = document.getElementById('legendIncomeYear');
      const legendExpense = document.getElementById('legendExpenseYear');

      container.innerHTML = '';

      if (listYear.length === 0) {
        const div = document.createElement('div');
        div.className = 'no-data';
        div.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ';
        container.appendChild(div);

        balanceEl.textContent = '0.00 ‡∏ø';
        updatePieChart(0, 0, pieChart, pieCenter, legendIncome, legendExpense);
        return;
      }

      const monthly = {};
      let totalIncomeYear = 0;
      let totalExpenseYear = 0;

      listYear.forEach(item => {
        const [y, m] = item.date.split('-').map(v => parseInt(v, 10));
        if (!monthly[m]) {
          monthly[m] = { income: 0, expense: 0 };
        }
        if (item.type === 'income') {
          monthly[m].income += item.amount;
          totalIncomeYear += item.amount;
        } else {
          monthly[m].expense += item.amount;
          totalExpenseYear += item.amount;
        }
      });

      const monthsOrder = Object.keys(monthly)
        .map(Number)
        .sort((a, b) => a - b);

      const monthsTH = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                        '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

      const table = document.createElement('table');
      table.className = 'day-table';
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
          <th class="text-right">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</th>
          <th class="text-right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</th>
          <th class="text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      monthsOrder.forEach(m => {
        const info = monthly[m];
        const balance = info.income - info.expense;

        const tr = document.createElement('tr');
        const tdMonth = document.createElement('td');
        tdMonth.textContent = monthsTH[m - 1];
        tr.appendChild(tdMonth);

        const tdIncome = document.createElement('td');
        tdIncome.className = 'text-right';
        tdIncome.textContent = formatNumber(info.income);
        tr.appendChild(tdIncome);

        const tdExpense = document.createElement('td');
        tdExpense.className = 'text-right';
        tdExpense.textContent = formatNumber(info.expense);
        tr.appendChild(tdExpense);

        const tdBal = document.createElement('td');
        tdBal.className = 'text-right';
        tdBal.textContent = formatNumber(balance);
        tr.appendChild(tdBal);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);

      balanceEl.textContent =
        formatNumber(totalIncomeYear - totalExpenseYear) + ' ‡∏ø';
      updatePieChart(totalIncomeYear, totalExpenseYear,
        pieChart, pieCenter, legendIncome, legendExpense);
    }

    function refreshUI() {
      const allList = loadTransactions();

      const listMonth = getFilteredByMonth(allList);
      const listYear = getFilteredByYear(allList);

      renderMonth(listMonth);
      renderYearSummary(listYear);
      updateMonthBalance(allList);
    }

    /* --- CRUD --- */

    function addOrUpdateTransaction() {
      const dateInput = document.getElementById('date');
      const date = dateInput.value;
      const maxDate = dateInput.max || todayString();

      if (!date) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
        return;
      }
      if (date > maxDate) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ');
        return;
      }

      const titleInput = document.getElementById('title');
      const amountInput = document.getElementById('amount');

      const title = titleInput.value.trim();
      const amount = parseFloat(amountInput.value || '0');

      if (!amount || amount <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      const catList = getCategoryList(currentType);
      const catObj = catList.find(c => c.key === selectedCategoryKey);
      if (!catObj) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
        return;
      }

      const list = loadTransactions();

      if (editingId !== null) {
        const idx = list.findIndex(t => t.id === editingId);
        if (idx !== -1) {
          list[idx].date = date;
          list[idx].type = currentType;
          list[idx].title = title;
          list[idx].amount = amount;
          list[idx].categoryKey = catObj.key;
        }
        editingId = null;
        document.getElementById('btnSave').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      } else {
        list.push({
          id: Date.now(),
          date,
          type: currentType,
          title,
          amount,
          categoryKey: catObj.key
        });
      }

      saveTransactions(list);

      amountInput.value = '';
      titleInput.value = '';
      selectedCategoryKey = null;
      populateCategoryGrid();

      refreshUI();
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    function clearAll() {
      if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        localStorage.removeItem(STORAGE_KEY);
        editingId = null;
        document.getElementById('btnSave').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        refreshUI();
      }
    }

    function startEdit(id) {
      const list = loadTransactions();
      const item = list.find(t => t.id === id);
      if (!item) return;

      editingId = id;

      switchTab('tab1');

      document.getElementById('date').value = item.date;
      setType(item.type);
      selectedCategoryKey = item.categoryKey;
      populateCategoryGrid();

      document.getElementById('title').value = item.title || '';
      document.getElementById('amount').value = item.amount;

      document.getElementById('btnSave').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    }

    function deleteTransaction(id) {
      if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      let list = loadTransactions();
      list = list.filter(t => t.id !== id);
      saveTransactions(list);

      if (editingId === id) {
        editingId = null;
        document.getElementById('btnSave').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      }

      refreshUI();
    }

    /* --- Tabs --- */

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
      });
    }

    function setupEvents() {
      document.getElementById('btnIncome')
        .addEventListener('click', () => setType('income'));
      document.getElementById('btnExpense')
        .addEventListener('click', () => setType('expense'));

      document.getElementById('btnSave')
        .addEventListener('click', addOrUpdateTransaction);

      document.getElementById('filterMonth')
        .addEventListener('change', refreshUI);

      document.getElementById('filterYear')
        .addEventListener('change', refreshUI);

      document.getElementById('btnClearAll')
        .addEventListener('click', clearAll);

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
    }

    window.onload = function () {
      setTodayAndMax();
      setupEvents();
      setType('income');
      refreshUI();
    };
  </script>
</body>
</html>
